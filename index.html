<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Last Words</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background:#05070c;
      color:#fff;
      overflow-x:hidden;
    }

    /* Estrellas */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      background:
        radial-gradient(1px 1px at 15% 25%, rgba(255,255,255,.9), transparent),
        radial-gradient(1px 1px at 30% 70%, rgba(255,255,255,.7), transparent),
        radial-gradient(1px 1px at 55% 35%, rgba(255,255,255,.8), transparent),
        radial-gradient(1px 1px at 80% 60%, rgba(255,255,255,.6), transparent),
        radial-gradient(1px 1px at 90% 20%, rgba(255,255,255,.7), transparent);
      opacity:.55;
      animation:twinkle 6s infinite alternate;
      pointer-events:none;
      z-index:-1;
    }
    @keyframes twinkle { from{opacity:.35} to{opacity:.75} }

    .container{
      max-width:1100px;
      margin:0 auto;
      padding:28px 16px 60px;
    }

    .header{
      text-align:center;
      margin-bottom:18px;
    }
    .header h1{
      margin:0;
      font-weight:300;
      letter-spacing:1px;
      font-size:44px;
    }
    .header p{
      margin:8px 0 0;
      opacity:.75;
      font-size:15px;
    }

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 1.5fr 1fr;
      gap:18px;
      align-items:start;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns:1fr; }
      .header h1{ font-size:38px; }
    }

    /* Cards */
    .card{
      background:#0b1220;
      border:1px solid #1f2937;
      border-radius:14px;
      padding:16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .card h2{
      margin:0 0 10px;
      font-weight:400;
      font-size:18px;
    }
    .muted{ opacity:.7; font-size:13px; margin:0; }

    /* Map */
    #map{
      height:520px;
      border-radius:14px;
      border:1px solid #1f2937;
      overflow:hidden;
    }
    @media (max-width: 900px){
      #map{ height:420px; }
    }

    /* Pay box */
    .price{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin:10px 0 14px;
      padding:12px;
      border-radius:12px;
      background:#111827;
      border:1px solid #1f2937;
    }
    .price strong{ font-size:16px; font-weight:600; }
    .badge{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background:#0a2a1a;
      border:1px solid rgba(34,197,94,.35);
      color:#7CFFB2;
    }

    /* Form */
    label{ font-size:12px; opacity:.8; display:block; margin:10px 0 6px; }
    input, textarea{
      width:100%;
      padding:10px 10px;
      border-radius:10px;
      border:1px solid #1f2937;
      background:#0f172a;
      color:#fff;
      outline:none;
    }
    textarea{ min-height:90px; resize:vertical; }

    .btn{
      width:100%;
      border:none;
      padding:11px 12px;
      border-radius:10px;
      background:#2563eb;
      color:#fff;
      cursor:pointer;
      font-weight:600;
      margin-top:12px;
    }
    .btn:hover{ background:#1e40af; }

    .locked{
      opacity:.55;
      filter: grayscale(35%);
      pointer-events:none;
    }
    .locknote{
      margin-top:10px;
      font-size:13px;
      padding:10px 12px;
      border-radius:12px;
      background:#111827;
      border:1px dashed rgba(255,255,255,.18);
      opacity:.85;
    }
    .oknote{
      margin-top:10px;
      font-size:13px;
      padding:10px 12px;
      border-radius:12px;
      background:#0a2a1a;
      border:1px solid rgba(34,197,94,.35);
      color:#7CFFB2;
      display:none;
    }

    /* Messages list */
    .messages{
      max-height:260px;
      overflow:auto;
      padding-right:6px;
    }
    .message{
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:10px 0;
      font-size:14px;
    }
    .message:last-child{ border-bottom:none; }
    .message small{ display:block; opacity:.65; margin-top:4px; }

    /* Marker styles */
    .pulse{
      width:34px; height:34px;
      border-radius:50%;
      background:#2563eb;
      display:flex; align-items:center; justify-content:center;
      color:#fff; font-size:18px;
      animation:pulse 1s infinite;
      box-shadow:0 0 0 0 rgba(37,99,235,.7);
    }
    @keyframes pulse{
      0%{ box-shadow:0 0 0 0 rgba(37,99,235,.65) }
      70%{ box-shadow:0 0 0 16px rgba(37,99,235,0) }
      100%{ box-shadow:0 0 0 0 rgba(37,99,235,0) }
    }
    .pin{
      width:34px; height:34px;
      border-radius:50%;
      background:#111827;
      border:1px solid rgba(255,255,255,.18);
      display:flex; align-items:center; justify-content:center;
      color:#fff; font-size:18px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>Last Words</h1>
      <p>Un mensaje. Un lugar. Un momento.</p>
    </div>

    <div class="grid">
      <!-- MAP -->
      <div class="card">
        <h2>Mapa global</h2>
        <p class="muted">Cada mensaje aparece como un pin en el mundo. Los nuevos brillan unos segundos.</p>
        <div id="map" style="margin-top:12px;"></div>
      </div>

      <!-- RIGHT PANEL -->
      <div class="card">
        <h2>Paga y publica</h2>
        <div class="price">
          <div>
            <strong>$8 USD</strong>
            <div class="muted">1 pago = 1 mensaje</div>
          </div>
          <div class="badge">Pago Ãºnico</div>
        </div>

        <!-- PayPal -->
        <div id="paypal-button-container"></div>

        <div class="locknote" id="lockNote">
          ðŸ”’ Primero realiza el pago para desbloquear el formulario.
          <br/>El emoji es fijo para mantener la estÃ©tica del mapa.
        </div>

        <div class="oknote" id="okNote">
          âœ… Pago confirmado. Ya puedes enviar 1 mensaje.
        </div>

        <!-- FORM (visible pero bloqueado hasta pago) -->
        <form id="messageForm" class="locked" autocomplete="off" style="margin-top:14px;">
          <label for="name">Tu nombre</label>
          <input id="name" required placeholder="Ej: Ana">

          <label for="message">Tu mensaje</label>
          <textarea id="message" required placeholder="Escribe tu mensaje..."></textarea>

          <label for="country">PaÃ­s</label>
          <input id="country" required placeholder="Ej: EspaÃ±a">

          <label for="location">Ciudad / DirecciÃ³n (para ubicar el pin)</label>
          <input id="location" required placeholder="Ej: Madrid, EspaÃ±a">

          <button class="btn" type="submit">Publicar mensaje</button>
        </form>

        <hr style="margin:16px 0; border:none; border-top:1px solid rgba(255,255,255,.10)">

        <h2>Mensajes</h2>
        <div class="messages" id="messages">Cargando...</div>
      </div>
    </div>
  </div>

  <!-- PAYPAL -->
  <script src="https://www.paypal.com/sdk/js?client-id=AX55daDbCKwDRrwqHYXBsV8f0a7zMIWEVLOC1KzS8xo-uKje_G4poVe-_Foww1x00w-NzGrXfOPlBZk-&currency=USD"></script>

  <!-- LEAFLET -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // âœ… Backend (Render)
    const API = "https://last-words-backend.onrender.com";

    // âœ… Emoji fijo (no editable por el usuario)
    const FIXED_EMOJI = "ðŸ’«";

    // Token 1 pago = 1 mensaje
    let paymentToken = null;

    // ===== MAP (dark) =====
    const map = L.map("map", { worldCopyJump: true }).setView([20, 0], 2);

    L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
      attribution: "Â© OpenStreetMap / CARTO"
    }).addTo(map);

    function makeIcon(emoji, pulsing=false){
      const cls = pulsing ? "pulse" : "pin";
      return L.divIcon({
        className: "",
        html: `<div class="${cls}">${emoji}</div>`,
        iconSize: [34,34],
        iconAnchor: [17,17]
      });
    }

    // ===== UI helpers =====
    const form = document.getElementById("messageForm");
    const lockNote = document.getElementById("lockNote");
    const okNote = document.getElementById("okNote");

    function unlockForm(){
      form.classList.remove("locked");
      lockNote.style.display = "none";
      okNote.style.display = "block";
    }
    function lockForm(){
      form.classList.add("locked");
      lockNote.style.display = "block";
      okNote.style.display = "none";
    }

    // ===== PAYPAL =====
    paypal.Buttons({
      createOrder: (data, actions) => actions.order.create({
        purchase_units: [{ amount: { value: "8.00" } }]
      }),
      onApprove: async (data, actions) => {
        await actions.order.capture();

        // pedir token al backend
        const res = await fetch(`${API}/payment-success`, { method: "POST" });
        const json = await res.json();
        paymentToken = json.token;

        unlockForm();
        alert("Pago completado. Puedes enviar 1 mensaje.");
      }
    }).render("#paypal-button-container");

    // ===== SEND MESSAGE =====
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      if (!paymentToken){
        alert("Debes pagar antes de enviar.");
        return;
      }

      const payload = {
        name: document.getElementById("name").value.trim(),
        message: document.getElementById("message").value.trim(),
        country: document.getElementById("country").value.trim(),
        location: document.getElementById("location").value.trim(),
        emoji: FIXED_EMOJI
      };

      try{
        const res = await fetch(`${API}/send-message`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-payment-token": paymentToken
          },
          body: JSON.stringify(payload)
        });

        const json = await res.json();

        if (json.status === "guardado") {
          // pin nuevo con pulso 5s
          if (json.lat != null && json.lon != null) {
            const popup = `<b>${payload.name}</b> ${FIXED_EMOJI}<br>${payload.message}<br><small>${payload.location}</small>`;
            const marker = L.marker([json.lat, json.lon], { icon: makeIcon(FIXED_EMOJI, true) })
              .addTo(map).bindPopup(popup);

            setTimeout(() => marker.setIcon(makeIcon(FIXED_EMOJI, false)), 5000);
          }

          alert("Mensaje publicado âœ¨");
          paymentToken = null; // token consumido
          e.target.reset();
          lockForm();
          await cargarMensajes();
        } else {
          alert("No se pudo publicar el mensaje.");
        }
      }catch(err){
        alert("Error conectando con el servidor.");
      }
    });

    // ===== LOAD MESSAGES (list + pins) =====
    async function cargarMensajes(){
      const messagesBox = document.getElementById("messages");
      messagesBox.textContent = "Cargando...";

      let data;
      try{
        const res = await fetch(`${API}/messages`);
        data = await res.json();
      }catch(e){
        messagesBox.textContent = "Error cargando mensajes.";
        return;
      }

      if (!Array.isArray(data) || data.length === 0){
        messagesBox.textContent = "AÃºn no hay mensajes.";
      } else {
        messagesBox.innerHTML = "";
        data.forEach(m => {
          const div = document.createElement("div");
          div.className = "message";
          div.innerHTML = `<b>${FIXED_EMOJI} ${m.country || ""}</b><br>${m.name || ""}: ${m.message || ""}<small>${m.location || ""}</small>`;
          messagesBox.appendChild(div);
        });
      }

      // limpiar marcadores (sin tocar el tile layer)
      map.eachLayer(layer => {
        if (!(layer instanceof L.TileLayer)) map.removeLayer(layer);
      });

      // re-agregar pines
      data.forEach(m => {
        if (m.lat == null || m.lon == null) return;
        const popup = `<b>${m.name || ""}</b> ${FIXED_EMOJI}<br>${m.message || ""}<br><small>${m.location || ""}</small>`;
        L.marker([m.lat, m.lon], { icon: makeIcon(FIXED_EMOJI, false) })
          .addTo(map)
          .bindPopup(popup);
      });
    }

    // init
    lockForm();
    cargarMensajes();
  </script>
</body>
</html>
