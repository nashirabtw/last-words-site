<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Last-Words ‚Äî Mapa</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
    body {
        margin: 0;
        padding: 0;
        background: #000;
        font-family: Arial, sans-serif;
        overflow: hidden;
    }

    #container {
        display: flex;
        height: 100vh;
        width: 100vw;
    }

    #map {
        flex: 1;
        height: 100%;
        z-index: 1;
    }

    /* PANEL DERECHA */
    #panel {
        width: 350px;
        background: #0d0d0d;
        padding: 25px;
        box-shadow: -2px 0 10px rgba(0,0,0,0.6);
        z-index: 9999;
        overflow-y: auto;
        color: white;
    }

    input, textarea {
        width: 100%;
        padding: 10px;
        background: #111;
        border: 1px solid #333;
        color: white;
        border-radius: 8px;
        margin-top: 8px;
        margin-bottom: 12px;
    }

    textarea {
        height: 110px;
        resize: none;
    }

    button {
        width: 100%;
        padding: 12px;
        background: white;
        border-radius: 20px;
        border: none;
        margin-top: 10px;
        font-weight: bold;
        cursor: pointer;
    }

    .paypal-container {
        margin-top: 10px;
        width: 100%;
    }

    /* Loader */
    #loader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.65);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        font-size: 22px;
        color: white;
        backdrop-filter: blur(4px);
    }

    /* Mensaje bonito */
    #successBox {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #0d0d0d;
        padding: 25px 40px;
        border-radius: 12px;
        display: none;
        text-align: center;
        color: white;
        box-shadow: 0 0 15px rgba(255,255,255,0.15);
        z-index: 10001;
    }
</style>

</head>
<body>

<div id="container">
    <div id="map"></div>

    <div id="panel">
        <h2>Deja tu mensaje üåç</h2>

        <label>Nombre</label>
        <input id="name" type="text">

        <label>Mensaje</label>
        <textarea id="message"></textarea>

        <label>Pa√≠s</label>
        <input id="country" type="text">

        <label>Emoji (ej: ‚ù§Ô∏è)</label>
        <input id="emoji" type="text">

        <p style="font-size:12px;color:#bbb;">
            Toca el mapa para elegir la ubicaci√≥n.
        </p>

        <div id="paypal-button-container" class="paypal-container"></div>

        <label>¬øTienes c√≥digo especial?</label>
        <input id="code-input" placeholder="Ingresa tu c√≥digo">
        <button onclick="useCode()">Usar c√≥digo</button>

        <button onclick="publishMessage()">Publicar mensaje</button>
    </div>
</div>

<!-- Loader -->
<div id="loader">Publicando tu mensaje...</div>

<!-- Mensaje bonito -->
<div id="successBox">‚ú® Tu mensaje fue publicado ‚ú®</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://www.paypal.com/sdk/js?client-id=sb&currency=USD"></script>

<script>
/* ============================
   MAPA
============================ */
let map = L.map('map').setView([20, 0], 3);

L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
    maxZoom: 19
}).addTo(map);

let marker = null;

map.on("click", function (e) {
    if (marker) map.removeLayer(marker);

    marker = L.marker(e.latlng).addTo(map);
    window.selectedLat = e.latlng.lat;
    window.selectedLng = e.latlng.lng;
});

/* ============================
   LOADER Y √âXITO
============================ */
function showLoader() {
    document.getElementById("loader").style.display = "flex";
}

function hideLoader() {
    document.getElementById("loader").style.display = "none";
}

function showSuccess() {
    const box = document.getElementById("successBox");
    box.style.display = "block";
    setTimeout(() => {
        box.style.display = "none";
    }, 2500);
}

/* ============================
   PAYPAL
============================ */
paypal.Buttons({
    createOrder: function (data, actions) {
        return actions.order.create({
            purchase_units: [{
                amount: { value: "10.00" }
            }]
        });
    },
    onApprove: function (data, actions) {
        return fetch("https://last-words-backend.onrender.com/payment-success", {
            method: "POST"
        })
        .then(r => r.json())
        .then(data => {
            localStorage.setItem("message_token", data.token);
            alert("Pago exitoso. Ahora puedes publicar tu mensaje.");
        });
    }
}).render("#paypal-button-container");

/* ============================
   USAR C√ìDIGO
============================ */
async function useCode() {
    const code = document.getElementById("code-input").value;

    showLoader();
    const res = await fetch("https://last-words-backend.onrender.com/use-free-code", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ code })
    });

    const data = await res.json();
    hideLoader();

    if (!res.ok) {
        alert(data.detail);
        return;
    }

    localStorage.setItem("message_token", data.token);
    showSuccess();
}

/* ============================
   PUBLICAR MENSAJE
============================ */
async function publishMessage() {
    showLoader();

    const token = localStorage.getItem("message_token");

    if (!token) {
        hideLoader();
        return alert("Primero paga o usa un c√≥digo.");
    }

    try {
        const res = await fetch("https://last-words-backend.onrender.com/send-message", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "x-payment-token": token
            },
            body: JSON.stringify({
                name: document.getElementById("name").value,
                message: document.getElementById("message").value,
                country: document.getElementById("country").value,
                emoji: document.getElementById("emoji").value,
                latitude: window.selectedLat,
                longitude: window.selectedLng
            })
        });

        const data = await res.json();

        hideLoader();

        if (!res.ok) {
            alert(data.detail);
            return;
        }

        localStorage.removeItem("message_token");
        showSuccess();

    } catch (err) {
        hideLoader();
        alert("Error inesperado");
    }
}
</script>

</body>
</html>
