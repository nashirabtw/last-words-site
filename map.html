<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Last-Words ‚Äì Mapa</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- PayPal -->
    <script src="https://www.paypal.com/sdk/js?client-id=AcdSyl1qm3V9VXGilsp5CRfod_JcevcSMcrsU05bLfs68cIpGaqoc-Zc_VJF2kL_8WdBUM72b5h29Btr&currency=USD"></script>

    <style>
        body {
            margin: 0;
            background: #0b0b0b;
            color: white;
            font-family: "Inter", sans-serif;
        }

        #map {
            width: 100%;
            height: 100vh;
        }

        .sidebar {
            position: fixed;
            top: 0;
            right: 0;
            width: 370px;
            height: 100vh;
            background: rgba(0,0,0,0.92);
            border-left: 1px solid rgba(255,255,255,0.1);
            padding: 25px;
            backdrop-filter: blur(12px);
            overflow-y: auto;
        }

        .sidebar h2 {
            font-size: 24px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input, textarea {
            width: 100%;
            padding: 10px 12px;
            margin-top: 8px;
            margin-bottom: 12px;
            background: #111;
            border: 1px solid #333;
            border-radius: 7px;
            color: white;
            font-size: 15px;
        }

        textarea {
            height: 95px;
            resize: none;
        }

        /* Submit button */
        .btn-submit {
            width: 100%;
            padding: 12px;
            background: #ffffff;
            color: black;
            border-radius: 40px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            margin-top: 10px;
        }

        /* Free code box */
        .free-box {
            margin-top: 15px;
            padding: 10px;
            background: #111;
            border: 1px solid #333;
            border-radius: 7px;
        }

        .free-box input {
            margin-bottom: 6px;
        }

        /* PIN blink effect */
        @keyframes blink {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.35); opacity: 0.5; }
            100% { transform: scale(1); opacity: 1; }
        }

        .blink {
            animation: blink 1.4s infinite;
        }
    </style>
</head>
<body>

<div id="map"></div>

<div class="sidebar">
    <h2>Deja tu mensaje üåç</h2>

    <label>Nombre</label>
    <input type="text" id="name">

    <label>Mensaje</label>
    <textarea id="message"></textarea>

    <label>Pa√≠s</label>
    <input type="text" id="country">

    <label>Emoji (tu pin)</label>
    <input type="text" id="emoji" placeholder="‚ù§Ô∏è üò¢ ‚ú®">

    <label>Ubicaci√≥n seleccionada</label>
    <input type="text" id="location" disabled style="opacity: 0.5;">

    <!-- PAYPAL BUTTON -->
    <div id="paypal-button-container" style="margin-top: 15px;"></div>

    <!-- FREE CODE SYSTEM -->
    <div class="free-box">
        <label>¬øTienes un c√≥digo especial?</label>
        <input type="text" id="freeCode" placeholder="Ingresa tu c√≥digo">
        <button class="btn-submit" onclick="useFreeCode()">Usar c√≥digo</button>
    </div>
</div>

<script>
    // ===============================
    // MAPA
    // ===============================
    var map = L.map('map').setView([20, 0], 3);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
    }).addTo(map);

    let selectedLat = null;
    let selectedLng = null;

    map.on('click', function(e) {
        selectedLat = e.latlng.lat;
        selectedLng = e.latlng.lng;
        document.getElementById("location").value =
            selectedLat.toFixed(4) + ", " + selectedLng.toFixed(4);
    });

    // ===============================
    // LISTAR MENSAJES
    // ===============================
    async function loadMessages() {
        const res = await fetch("https://last-words-backend.onrender.com/messages");
        const data = await res.json();

        data.forEach(m => {
            const icon = L.divIcon({
                className: "blink",
                html: `<div style='font-size:22px;'>${m.emoji}</div>`,
            });

            L.marker([m.latitude, m.longitude], {icon}).addTo(map)
                .bindPopup(`<b>${m.name}</b><br>${m.message}<br><i>${m.country}</i>`);
        });
    }

    loadMessages();

    // ===============================
    // TOKEN DE FREE CODE
    // ===============================
    let paymentToken = null;

    async function useFreeCode() {
        const code = document.getElementById("freeCode").value.trim();

        if (!code) {
            alert("Ingresa un c√≥digo.");
            return;
        }

        const res = await fetch("https://last-words-backend.onrender.com/use-free-code", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({code})
        });

        if (!res.ok) {
            alert("C√≥digo inv√°lido o ya usado.");
            return;
        }

        const data = await res.json();
        paymentToken = data.token;
        alert("C√≥digo aceptado. Ahora puedes publicar tu mensaje.");
    }

    // ===============================
    // PAYPAL
    // ===============================
    paypal.Buttons({
        createOrder: function(data, actions) {
            return actions.order.create({
                purchase_units: [{ amount: { value: "1.00" }}]
            });
        },
        onApprove: function(data, actions) {
            return actions.order.capture().then(function(details) {
                fetch("https://last-words-backend.onrender.com/payment-success", {
                    method: "POST"
                })
                .then(r => r.json())
                .then(data => {
                    paymentToken = data.token;
                    alert("Pago completado. Ahora puedes enviar tu mensaje.");
                });
            });
        }
    }).render("#paypal-button-container");

    // ===============================
    // ENVIAR PIN
    // ===============================
    async function sendMessage() {
        if (!paymentToken) {
            alert("Debes pagar o usar un c√≥digo para publicar.");
            return;
        }

        const name = document.getElementById("name").value;
        const message = document.getElementById("message").value;
        const country = document.getElementById("country").value;
        const emoji = document.getElementById("emoji").value;

        if (!name || !message || !emoji || !selectedLat) {
            alert("Todos los campos y la ubicaci√≥n son necesarios.");
            return;
        }

        const body = {
            name, message, country, emoji,
            latitude: selectedLat,
            longitude: selectedLng
        };

        const res = await fetch("https://last-words-backend.onrender.com/send-message", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "x-payment-token": paymentToken
            },
            body: JSON.stringify(body)
        });

        if (res.ok) {
            alert("Mensaje enviado.");
            location.reload();
        } else {
            alert("Error enviando mensaje.");
        }
    }
</script>

<!-- Submit Button -->
<button class="btn-submit" onclick="sendMessage()" 
        style="position: fixed; bottom: 20px; right: 20px; width: 330px;">
    Publicar mensaje
</button>

</body>
</html>
