<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Last-Words Map</title>

    <!-- Leaflet MAP -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            background: #0b0b0b;
            font-family: "Inter", sans-serif;
            color: white;
        }

        /* MAPA OSCURO ESTILO NASA */
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: calc(100% - 380px);
            height: 100vh;
            background: black;
        }

        /* SIDEBAR */
        .sidebar {
            position: absolute;
            top: 0;
            right: 0;
            width: 380px;
            height: 100vh;
            padding: 25px;
            background: rgba(0,0,0,0.92);
            border-left: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            overflow-y: auto;
        }

        .sidebar h2 {
            font-size: 24px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input, textarea {
            width: 100%;
            padding: 12px;
            margin-top: 8px;
            margin-bottom: 12px;
            background: #111;
            border: 1px solid #333;
            border-radius: 7px;
            color: white;
            font-size: 15px;
        }

        textarea {
            resize: none;
            height: 90px;
        }

        button {
            width: 100%;
            padding: 14px;
            background: white;
            color: black;
            border-radius: 40px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            margin-top: 10px;
        }

        .code-box {
            margin-top: 15px;
            padding: 10px;
            background: #111;
            border: 1px solid #333;
            border-radius: 7px;
        }

        /* PIN PARPADEANDO */
        @keyframes blink {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.4); opacity: 0.4; }
            100% { transform: scale(1); opacity: 1; }
        }
        .blink {
            animation: blink 1.3s infinite;
        }
    </style>
</head>

<body>

    <!-- MAPA -->
    <div id="map"></div>

    <!-- SIDEBAR -->
    <div class="sidebar">
        <h2>Deja tu mensaje ðŸŒŽ</h2>

        <input type="text" id="name" placeholder="Nombre" />
        <textarea id="message" placeholder="Mensaje"></textarea>
        <input type="text" id="country" placeholder="PaÃ­s" />
        <input type="text" id="emoji" placeholder="Emoji (ejemplo: â¤ï¸)" readonly />

        <p style="opacity: .7; font-size:14px; margin-top:-5px;">
            Selecciona un punto en el mapa para elegir ubicaciÃ³n
        </p>

        <div class="code-box">
            <p style="margin-bottom:5px;">Â¿Tienes cÃ³digo especial?</p>
            <input type="text" id="freeCode" placeholder="Ingresa tu cÃ³digo" />
            <button onclick="useFreeCode()">Usar cÃ³digo</button>
        </div>

        <button onclick="publishMessage()">Publicar mensaje</button>
    </div>

    <!-- SCRIPT -->
    <script>

        const BACKEND = "https://last-words-backend.onrender.com";

        let selectedLat = null;
        let selectedLng = null;
        let paymentToken = null;

        // ===========================
        // MAPA OSCURO ESTILO NASA
        // ===========================
        const map = L.map("map").setView([20, 0], 2);

        L.tileLayer(
            "https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png",
            {
                maxZoom: 18,
                attribution: "&copy; OpenMapTiles & Stadia Maps"
            }
        ).addTo(map);

        // Cursor al dar clic
        map.on("click", (e) => {
            selectedLat = e.latlng.lat;
            selectedLng = e.latlng.lng;

            document.getElementById("emoji").value = "ðŸŒŸ";
        });

        // ===========================
        // CARGAR MENSAJES
        // ===========================
        async function loadMessages() {
            const res = await fetch(`${BACKEND}/messages`);
            const data = await res.json();

            data.forEach(msg => {
                const marker = L.marker([msg.latitude, msg.longitude]).addTo(map);
                marker.bindPopup(`
                    <b>${msg.name}</b><br>
                    ${msg.message}<br>
                    <i>${msg.emoji}</i><br>
                    <small>${msg.country}</small>
                `);
            });
        }
        loadMessages();

        // ===========================
        // CÃ“DIGO GRATIS
        // ===========================
        async function useFreeCode() {
            const code = document.getElementById("freeCode").value.trim();

            if (!code) return alert("Ingresa un cÃ³digo.");

            const res = await fetch(`${BACKEND}/use-free-code`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ code })
            });

            const data = await res.json();

            if (res.status !== 200) {
                alert(data.detail || "CÃ³digo invÃ¡lido");
                return;
            }

            paymentToken = data.token;
            alert("CÃ³digo activado ðŸŽ‰ Ya puedes publicar tu mensaje.");
        }

        // ===========================
        // PUBLICAR MENSAJE
        // ===========================
        async function publishMessage() {

            if (!paymentToken) {
                alert("Primero paga con PayPal o usa un cÃ³digo especial.");
                return;
            }

            if (!selectedLat || !selectedLng) {
                alert("Selecciona una ubicaciÃ³n en el mapa.");
                return;
            }

            const payload = {
                name: document.getElementById("name").value,
                message: document.getElementById("message").value,
                country: document.getElementById("country").value,
                emoji: document.getElementById("emoji").value,
                latitude: selectedLat,
                longitude: selectedLng
            };

            const res = await fetch(`${BACKEND}/send-message`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "x-payment-token": paymentToken
                },
                body: JSON.stringify(payload)
            });

            const data = await res.json();

            if (res.status !== 200) {
                alert(data.detail || "Error al enviar el mensaje");
                return;
            }

            alert("Mensaje publicado âœ¨");

            location.reload();
        }

    </script>
</body>
</html>
