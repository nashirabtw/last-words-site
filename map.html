<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Last-Words Map</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />

  <style>
    * { margin:0; padding:0; box-sizing:border-box }
    html, body { height:100%; overflow:hidden; background:#0b0b0b; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:#fff }
    #map { position:absolute; inset:0 auto 0 0; width:calc(100% - 380px); height:100vh; background:#000 } /* mapa full */
    .sidebar{
      position:absolute; top:0; right:0; width:380px; height:100vh; overflow-y:auto;
      background:rgba(0,0,0,.92); border-left:1px solid rgba(255,255,255,.08); backdrop-filter:blur(8px);
      padding:24px;
    }
    .sidebar h2{ font-size:24px; margin-bottom:12px; display:flex; gap:8px; align-items:center }
    input, textarea{ width:100%; background:#111; border:1px solid #333; color:#fff; border-radius:8px; padding:12px; font-size:15px; margin:.5rem 0 0.8rem }
    textarea{ height:92px; resize:none }
    button{ width:100%; border:none; border-radius:999px; padding:14px; font-weight:700; cursor:pointer; margin-top:.4rem }
    .ghost{ background:#fff; color:#000 }
    .codebox{ margin-top:.5rem; padding:.75rem; background:#0f0f0f; border:1px solid #242424; border-radius:10px }
    .muted{ opacity:.7; font-size:13px; margin-top:-6px }

    /* pin parpadeo */
    @keyframes blink { 0%{transform:scale(1);opacity:1} 50%{transform:scale(1.35);opacity:.45} 100%{transform:scale(1);opacity:1} }
    .blink{ animation:blink 1.3s infinite }
  </style>
</head>
<body>

  <div id="map"></div>

  <div class="sidebar">
    <h2>Deja tu mensaje ðŸŒŽ</h2>

    <input id="name" placeholder="Nombre" />
    <textarea id="message" placeholder="Mensaje"></textarea>
    <input id="country" placeholder="PaÃ­s" />
    <input id="emoji" placeholder="Emoji (ej.: â¤ï¸)" readonly />
    <p class="muted">Toca el mapa para elegir la ubicaciÃ³n.</p>

    <div class="codebox">
      <div style="margin-bottom:.4rem">Â¿Tienes cÃ³digo especial?</div>
      <input id="freeCode" placeholder="Ingresa tu cÃ³digo" />
      <button class="ghost" onclick="useFreeCode()">Usar cÃ³digo</button>
    </div>

    <button class="ghost" onclick="publishMessage()">Publicar mensaje</button>
  </div>

  <script>
    // --- Cache-bust sencillo para evitar JS viejo en Vercel/cliente ---
    console.log("LW map rev=", Date.now()); // fuerza recarga al cambiar el archivo

    const BACKEND = "https://last-words-backend.onrender.com";
    let selectedLat = null, selectedLng = null, paymentToken = null;

    // =======================
    // MAPA con fallback auto
    // =======================
    const map = L.map("map", { zoomControl:true }).setView([20,0], 2);

    // Capa Dark (sin API key)
    const cartoDark = L.tileLayer(
      "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png",
      { maxZoom:19, attribution:'&copy; <a href="https://carto.com/">CARTO</a> Â· Â© OpenStreetMap' }
    );

    // Fallback claro OSM si hay cualquier error de tiles
    const osm = L.tileLayer(
      "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
      { maxZoom:19, attribution:'Â© OpenStreetMap contributors' }
    );

    let usingFallback = false;
    cartoDark.addTo(map);
    cartoDark.on("tileerror", () => {
      if (!usingFallback) {
        usingFallback = true;
        map.removeLayer(cartoDark);
        osm.addTo(map);
        console.warn("Carto Dark fallÃ³; usando OSM como fallback.");
      }
    });

    // pick location
    map.on("click", e => {
      selectedLat = e.latlng.lat;
      selectedLng = e.latlng.lng;
      document.getElementById("emoji").value = "ðŸŒŸ";
    });

    // =======================
    // CARGAR MENSAJES
    // =======================
    (async function loadMessages(){
      try{
        const r = await fetch(BACKEND + "/messages");
        const arr = await r.json();
        arr.forEach(m=>{
          const mk = L.marker([m.latitude, m.longitude]).addTo(map);
          mk.bindPopup(`<b>${m.name}</b><br>${m.message}<br><i>${m.emoji}</i><br><small>${m.country}</small>`);
        });
      }catch(e){ console.error("No se pudieron cargar mensajes:", e); }
    })();

    // =======================
    // CÃ“DIGO GRATIS â†’ token
    // =======================
    async function useFreeCode(){
      const code = document.getElementById("freeCode").value.trim();
      if(!code) return alert("Ingresa un cÃ³digo.");
      const r = await fetch(BACKEND + "/use-free-code", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ code })
      });
      const data = await r.json();
      if(r.status !== 200){ return alert(data.detail || "CÃ³digo invÃ¡lido"); }
      paymentToken = data.token;
      alert("CÃ³digo activado ðŸŽ‰ Ya puedes publicar tu mensaje.");
    }

    // =======================
    // PUBLICAR MENSAJE
    // =======================
    async function publishMessage(){
      if(!paymentToken) return alert("Primero paga con PayPal o usa un cÃ³digo especial.");
      if(!selectedLat || !selectedLng) return alert("Selecciona una ubicaciÃ³n en el mapa.");

      const payload = {
        name: document.getElementById("name").value,
        message: document.getElementById("message").value,
        country: document.getElementById("country").value,
        emoji: document.getElementById("emoji").value,
        latitude: selectedLat,
        longitude: selectedLng
      };

      const r = await fetch(BACKEND + "/send-message", {
        method:"POST",
        headers:{ "Content-Type":"application/json", "x-payment-token": paymentToken },
        body: JSON.stringify(payload)
      });
      const data = await r.json();
      if(r.status !== 200) return alert(data.detail || "Error al enviar el mensaje");
      alert("Mensaje publicado âœ¨");
      location.reload();
    }
  </script>
</body>
</html>
