<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Last Words ‚Äî Mapa Global</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- PayPal -->
    <script src="https://www.paypal.com/sdk/js?client-id=sb&currency=USD"></script>

    <style>
        body {
            margin: 0;
            background: #000;
            color: #fff;
            font-family: Arial, sans-serif;
            overflow: hidden;
            display: flex;
            height: 100vh;
        }

        /* Fondo animado premium */
        #bg-anim {
            position: fixed;
            top: 0; left: 0;
            width: 100vw;
            height: 100vh;
            background-image: url("https://upload.wikimedia.org/wikipedia/commons/5/57/Mercator_projection_SW.jpg");
            background-size: cover;
            background-position: center;
            opacity: 0.15;
            filter: blur(3px);
            z-index: -1;
            animation: drift 40s linear infinite;
        }

        @keyframes drift {
            0% { transform: scale(1) translate(0,0); }
            50% { transform: scale(1.12) translate(-15px, 10px); }
            100% { transform: scale(1) translate(0,0); }
        }

        /* Mapa */
        #map {
            width: 70vw;
            height: 100vh;
        }

        /* Formulario */
        #form {
            width: 30vw;
            height: 100vh;
            padding: 25px;
            background: rgba(0, 0, 0, 0.92);
            border-left: 1px solid #222;
            overflow-y: auto;
        }

        h2 {
            font-weight: 300;
            margin-top: 0;
            font-size: 1.7rem;
        }

        label {
            font-size: 14px;
            opacity: 0.85;
        }

        input, textarea {
            width: 100%;
            padding: 10px;
            margin-top: 4px;
            margin-bottom: 14px;
            border-radius: 4px;
            border: none;
            background: #181818;
            color: #fff;
            font-size: 15px;
        }

        textarea { resize: none; }

        /* Blink para mensajes nuevos */
        .blink {
            animation: blink 0.7s steps(2, start) infinite;
        }

        @keyframes blink {
            to { opacity: 0; }
        }

        /* Popup estilo cuaderno */
        .popup-box {
            background: #fff;
            color: #000;
            padding: 14px;
            border-radius: 8px;
            width: 210px;
            font-size: 14px;
            line-height: 1.3rem;
        }

        .popup-title {
            font-weight: bold;
            margin-bottom: 6px;
        }

        /* Movil */
        @media(max-width: 900px) {
            #map {
                width: 100vw;
                height: 60vh;
            }
            #form {
                width: 100vw;
                height: 40vh;
            }
        }
    </style>
</head>

<body>

    <div id="bg-anim"></div>

    <div id="map"></div>

    <div id="form">
        <h2>Deja tu mensaje üåç</h2>

        <label>Nombre</label>
        <input id="name" type="text">

        <label>Emoji (tu pin en el mapa)</label>
        <input id="emoji" type="text" placeholder="‚ù§Ô∏è üò¢ ‚ú®">

        <label>Pa√≠s</label>
        <input id="country" type="text">

        <label>Mensaje</label>
        <textarea id="message" rows="4"></textarea>

        <label>Ubicaci√≥n seleccionada</label>
        <input id="latitude" type="text" readonly>
        <input id="longitude" type="text" readonly>

        <div id="paypal-button-container"></div>
    </div>

<script>
const API_URL = "https://last-words-backend.onrender.com";
let paymentToken = null;

// -----------------------
// MAPA OSCURO PREMIUM
// -----------------------
const map = L.map("map", {
    zoomControl: true,
    worldCopyJump: true,
}).setView([20, 0], 2.3);

L.tileLayer(
    "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
    { maxZoom: 6, minZoom: 2 }
).addTo(map);

let markerSelect = null;

map.on("click", (e) => {
    const lat = e.latlng.lat;
    const lng = e.latlng.lng;

    document.getElementById("latitude").value = lat;
    document.getElementById("longitude").value = lng;

    if (markerSelect) map.removeLayer(markerSelect);

    markerSelect = L.marker([lat, lng]).addTo(map);
});

// -----------------------
// CARGAR MENSAJES
// -----------------------
async function loadMessages() {
    const r = await fetch(`${API_URL}/messages`);
    const msgs = await r.json();

    msgs.forEach(msg => {
        const emojiIcon = L.divIcon({
            html: `<div style="font-size:28px;">${msg.emoji}</div>`,
            className: "",
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });

        const mk = L.marker([msg.latitude, msg.longitude], { icon: emojiIcon }).addTo(map);

        // si es nuevo (<5 min)
        const creado = new Date(msg.created_at);
        if ((Date.now() - creado) / 1000 < 300) {
            mk._icon.classList.add("blink");
            setTimeout(() => mk._icon.classList.remove("blink"), 5000);
        }

        mk.bindPopup(`
            <div class="popup-box">
                <div class="popup-title">${msg.name} ‚Äî ${msg.country}</div>
                <div>${msg.message}</div>
            </div>
        `);
    });
}
loadMessages();

// -----------------------
// PAYPAL $10
// -----------------------
paypal.Buttons({
    createOrder: (data, actions) => {
        return actions.order.create({
            purchase_units: [{
                amount: { value: "10.00" }
            }]
        });
    },

    onApprove: async () => {
        const r = await fetch(`${API_URL}/payment-success`, { method: "POST" });
        const j = await r.json();
        paymentToken = j.token;
        sendMessage();
    }
}).render("#paypal-button-container");

// -----------------------
// ENVIAR MENSAJE
// -----------------------
async function sendMessage() {

    if (!paymentToken) return alert("Error con el pago.");

    const payload = {
        name: name.value,
        emoji: emoji.value,
        country: country.value,
        message: message.value,
        latitude: parseFloat(latitude.value),
        longitude: parseFloat(longitude.value)
    };

    const res = await fetch(`${API_URL}/send-message`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "x-payment-token": paymentToken
        },
        body: JSON.stringify(payload)
    });

    if (res.ok) {
        alert("Tu mensaje ha sido publicado ‚úî");
        location.reload();
    } else {
        alert("No se pudo guardar el mensaje.");
    }
}
</script>

</body>
</html>
