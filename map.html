<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Last-Words — Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
    body, html {
        margin: 0;
        padding: 0;
        height: 100%;
        background: #000;
        font-family: Arial, sans-serif;
    }

    #map {
        width: 100%;
        height: 100%;
    }

    /* ===== DESKTOP FORM ===== */
    #formContainer {
        position: absolute;
        top: 0;
        right: 0;
        width: 320px;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(5px);
        padding: 20px;
        color: white;
        overflow-y: auto;
    }

    /* ===== MOBILE FLOATING BUTTON ===== */
    #mobileBtn {
        display: none;
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: white;
        color: black;
        border-radius: 50px;
        padding: 14px 20px;
        font-weight: bold;
        font-size: 1rem;
        border: none;
        cursor: pointer;
        z-index: 9999;
    }

    /* ===== MOBILE SLIDE-UP FORM ===== */
    #mobileForm {
        display: none;
        position: fixed;
        bottom: 0;
        width: 100%;
        background: rgba(10, 10, 10, 0.95);
        backdrop-filter: blur(6px);
        padding: 20px;
        border-top-left-radius: 16px;
        border-top-right-radius: 16px;
        color: white;
        z-index: 9999;
    }

    #mobileForm input, 
    #mobileForm textarea, 
    #formContainer input,
    #formContainer textarea {
        width: 100%;
        padding: 10px;
        margin-top: 10px;
        border-radius: 6px;
        border: none;
        font-size: 1rem;
    }

    #mobileForm button,
    #formContainer button {
        margin-top: 15px;
        width: 100%;
        padding: 12px;
        background: white;
        border: none;
        font-size: 1rem;
        border-radius: 8px;
        cursor: pointer;
    }

    /* ===== MOBILE BREAKPOINT ===== */
    @media (max-width: 768px) {
        #formContainer {
            display: none;
        }
        #mobileBtn {
            display: block;
        }
    }

    /* =============================================
       CUSTOM POPUP STYLES (Cinematic + Poetic Card)
       ============================================= */

    .custom-popup .leaflet-popup-content-wrapper {
        background: transparent !important;
        box-shadow: none !important;
    }

    .custom-popup .leaflet-popup-content {
        margin: 0 !important;
    }

    /* Card container */
    .popup-card {
        background: rgba(0,0,0,0.85);
        backdrop-filter: blur(6px);
        color: white;
        width: 260px;
        padding: 18px;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,0.12);
        animation: fadeSlide 0.4s ease forwards;
    }

    /* Header: emoji + name */
    .popup-header {
        font-size: 1.3rem;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .popup-emoji {
        font-size: 1.4rem;
    }

    .popup-name {
        font-weight: bold;
        font-size: 1.1rem;
    }

    /* Message text */
    .popup-message {
        opacity: 0.85;
        font-size: 1rem;
        line-height: 1.4;
        margin-bottom: 14px;
        font-style: italic;
    }

    /* Country in corner */
    .popup-country {
        font-size: 0.85rem;
        opacity: 0.55;
        text-align: right;
        margin-bottom: 6px;
    }

    /* Bottom divider */
    .popup-bottom-line {
        height: 1px;
        width: 100%;
        background: linear-gradient(
            to right, 
            rgba(255,255,255,0.2), 
            rgba(255,255,255,0.03)
        );
    }

    /* Smooth cinematic animation */
    @keyframes fadeSlide {
        from {
            opacity: 0;
            transform: translateY(8px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

</style>
</head>

<body>

<div id="map"></div>

<!-- Desktop Form -->
<div id="formContainer">
    <h2>Leave Your Message</h2>

    <input id="name" placeholder="Your name">
    <textarea id="message" rows="3" placeholder="Your message"></textarea>
    <input id="country" placeholder="Country">
    <input id="emoji" placeholder="Emoji (example: ❤️)">
    <button onclick="startPayment()">Pay & Send</button>
</div>

<!-- Mobile Floating Button -->
<button id="mobileBtn" onclick="openMobileForm()">+ Add Message</button>

<!-- Mobile Slide-Up Form -->
<div id="mobileForm">
    <h2>Leave Your Message</h2>

    <input id="m_name" placeholder="Your name">
    <textarea id="m_message" rows="3" placeholder="Your message"></textarea>
    <input id="m_country" placeholder="Country">
    <input id="m_emoji" placeholder="Emoji">

    <button onclick="startPaymentMobile()">Pay & Send</button>
    <button style="background:#444;color:white;margin-top:8px;" onclick="closeMobileForm()">Close</button>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const API_URL = "https://last-words-backend.onrender.com";

/* MAP INIT */
const map = L.map('map').setView([20, 0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
}).addTo(map);

/* LOAD MARKERS WITH FLASH AND CUSTOM POPUP */
fetch(API_URL + "/messages")
.then(r => r.json())
.then(messages => {
    messages.forEach(m => {

        const createdTime = new Date(m.created_at);
        const now = new Date();
        const diffSeconds = (now - createdTime) / 1000;
        const isNew = diffSeconds < 5;

        const marker = L.marker([m.latitude, m.longitude]).addTo(map);

        marker.bindPopup(`
            <div class="popup-card">
                <div class="popup-header">
                    <span class="popup-emoji">${m.emoji}</span>
                    <span class="popup-name">${m.name}</span>
                </div>

                <div class="popup-message">
                    “${m.message}”
                </div>

                <div class="popup-country">
                    ${m.country}
                </div>

                <div class="popup-bottom-line"></div>
            </div>
        `, { className: "custom-popup" });

        if (isNew) {
            const icon = marker._icon;
            icon.style.transition = "filter 0.3s ease";
            icon.style.filter = "brightness(2.5)";

            let flashes = 0;
            const flashInterval = setInterval(() => {
                flashes++;
                icon.style.filter = 
                    icon.style.filter === "brightness(1)" 
                    ? "brightness(2.5)" 
                    : "brightness(1)";

                if (flashes >= 6) { 
                    clearInterval(flashInterval);
                    icon.style.filter = "brightness(1)";
                }
            }, 350);
        }

    });
});

/* MOBILE FORM FUNCTIONS */
function openMobileForm() {
    document.getElementById("mobileForm").style.display = "block";
}

function closeMobileForm() {
    document.getElementById("mobileForm").style.display = "none";
}

/* PAYMENT PLACEHOLDERS */
function startPayment() {
    alert("Payment placeholder: integrate PayPal here.");
}

function startPaymentMobile() {
    alert("Payment placeholder: integrate PayPal for mobile.");
}
</script>

</body>
</html>
